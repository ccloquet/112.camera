<!DOCTYPE html> 
<!--https://www.webcodegeeks.com/html5/html5-file-upload-example/-->
<html>

<head>
	<title>112.camera</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />

	<style>
		body
		{
			overflow-x:hidden;overflow-y:hidden;font-family:"Lucida Sans Unicode", "Lucida Grande", "Arial", Helvetica, sans-serif; background-color:#05466D; color:#eeeeee; padding:0% 2.5%; height:100%;
		 
		}
		.streaming_on 
		{
			border: 3px solid red;
			border-radius: 10px;
		}
		.center-div
		{
			font-size:125%;
			position: fixed; right: 0;  bottom: 30px;  left: 0;
			width: 300px;  height: 2.5em;
			margin-left: auto;
			margin-right: auto;
			padding-top:1.5em; 
  			border-radius: 3px;
	 		border: 3px solid red; 
			color:white;
			background:rgba(255,0,0,.75);
			text-align:center
		}

		.blink_me 
		{
			animation: blinker 3.5s ease infinite;
		}

		@keyframes blinker 
		{
		  50% { opacity: 0;  }
		}
		#userid
		{
			text-align:center; font-size:2.5em; width:100%;overflow: hidden;  text-overflow: ellipsis; 
			font-family:"Lucida Sans Unicode", "Lucida Grande", "Arial", Helvetica, sans-serif;
			background:transparent;
			border:none;
			border-bottom:1px solid #607d8b;
			color:#61A0C6;
			font-weight:normal
		}
	</style>

	<script	src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.18/peer.min.js"></script>
	<script src='showme.js?a=6'></script>
	<script src='params.js?a=6'></script>
</head>
<body>
	<center>

	<div id='config'>
		<div style='font-weight:normal; margin-top:1.5em'><b style='margin-bottom:.5em'>Help the 112 to ðŸ“·  through a ðŸ”—</b><br><br>Enter your âœ† number:</div><br>

		<input id='userid' type='tel'  autofocus> 
		<br>
		<br>
		<div style='font-size:2em;border-radius:5px;padding:.1em;background:#AA2900;color:#61A0C6;' onclick='peer_init()'>GO</div><br> 
	</div>
	<div id='text_for_112' style='color:#607d8b'>DEMO ONLY - NOT FOR REAL USE<br>I UNDERSTAND THE RISKS</div>
	
	<br>
	<video height="350" autoplay id="video-0" style="border-radius:10px; display:none"></video><br> <!-- VIDEO ELEMENT FOR WEBRTC -->
	<div id='red_dot' class='blink_me' style='position:fixed; top:3.7em; right:1.5em; font-size:3em;margin-top:-2em;color:red;display:none'>&#9679;</div>	
	<div id='stop_video' style='position:fixed; bottom:1em; right:0; left:0; text-align:center; display:none'>To stop video: reload the page or close the browser</div>
	</center>
	<div class='center-div blink_me' id='waiting' style='display:none'>WAITING FOR CONNEXION</div>

	
	<script>
 
	var peer         = null;
	var video 	 = document.querySelector('video');

	// function: initialize peer & mediastream
	function peer_init()
	{	
		var userid       = parseInt($('#userid').val()); 

		if (!validate_userid(userid)) 
		{
			error_msg();
			return false;
		}

		$('#config').slideUp(1500, function()
		{
			$('#text_for_112').html('<br>Ask the 112 operator to connect on<br><b>' + location.href.replace('https://', '') + userid +'</b>').css('color', 'white')
			$('#waiting').fadeIn()
		})
		
		var mypeerid     = userid + '-1'	 
		var remotepeerid = userid + '-0'	

		
		if (!hasGetUserMedia()) 
		{
			return false;
		}

		$.post(	'query.php', 
			{
				action:	'get_ice_servers',
			},						
			function(e)					
			{ 
				var ice_servers 	= e.ice_servers	
				var connexion_timeout 	= null;
				peer_loop()
 
			 	function peer_loop()
				{

				peer = new Peer(mypeerid, {config: {iceServers: e.ice_servers}, host:peerjs_url, debug:3, port: 443, secure:true} );

				// to reconnect when the peer has been disconnected
				peer.on('connection', function(e){console.log("A"); peer.destroy(); video.classList.remove("streaming_on"); $('#red_dot').hide(); setTimeout(peer_loop, 1000); console.log(e)})

				var heartbeater = makePeerHeartbeater( peer );

				//console.log(peer)

				video.classList.remove("streaming_on")
				$('#red_dot').hide()
				if (connexion_timeout != null) clearTimeout(connexion_timeout)

				peer.on('open',  function(id)  
				{
					console.log('My peer ID is: ' + id); 
				});

				peer.on('error', function(err) 
				{
					switch(err.type)
					{
						case 'peer-unavailable':
							peer_destroy(function(){video.classList.remove("streaming_on"); $('#red_dot').hide(); setTimeout(peer_loop, 1000); })
							break;
						default:
							error_msg()
							peer_destroy(function(){video.classList.remove("streaming_on"); $('#red_dot').hide();  })
							
					}
							
				});

				navigator.mediaDevices.getUserMedia({video: { facingMode: "environment" }, audio:true})
				.then(function(my_media_stream) 
				{
					video.srcObject   = my_media_stream
					var call 	  = peer.call(remotepeerid,  my_media_stream);	
					connexion_timeout = setTimeout(function(){ clearTimeout(connexion_timeout); connexion_timeout = null; video.classList.add("streaming_on"); $('#red_dot').show(); $('#video-0').show(); $('#stop_video').fadeIn(); $('#waiting').hide()}, 7000) 
				 
				})
				.catch(function(err) 
				{
					console.log('ERROR', err)
					peer_destroy(function(){video.classList.remove("streaming_on"); $('#red_dot').hide()})
				});
				}
			}, 'json');
	}
	
	</script>
    </body>
</html>



